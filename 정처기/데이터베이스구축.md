# 데이터베이스 구축
## 데이터베이스 구축
### 개념
- 데이터베이스 (공 저 통 운) : 공유, 저장, 통합, 운영
- 데이터 언어 ( 상암 DMC )
  - DDL : 구조와 제약 조건 정의
  - DML : 데이터 처리 및 조작
  - DCL : 보안, 권한, 무결성 및 병행 제어
- 스키마 : 데이터베이스의 구조, 제약조건, 속성, 개체, 관계를 포함한 전반적인 명세 기술
  - 3계층
    - 외부 - 사용자 뷰 : 접근시 C, Java, SQL등의 언어 사용
      ~ 논리적 독립성 존재 ~
    - 개념 - 전체적인 뷰 : 전체적인 논리적 구조
      ~ 물리적 독립성 존재 ~ 
    - 내부 - 저장 스키마 : 물리적 저장장치 관점에서 데이터베이스 구조 
- DBMS : 데이터베이스를 효과적으로 관리하고 조작하기 위한 전용 소프트웨어 
  - 기능 : 정의, 조작, 제어, 공유, 보호, 구축, 유지보수 
  - 종류
    - 계층형 : 트리구조
    - 네트워크형 : 다대다 관계 가능, CODASYL
    - 관계형 : 테이블 구조의 모델, SQL 사용
    - 객체 지향형 : 객체지향 프로그래밍 개념에 기반
    - 객체 관계형 : 관계형 + 객체지향 개념
    - NoSQL : 다양한 특성 지원
    - NewSQL : RDBMS + NoSQL의 장점 결합 

### 설계
- DB 설계는 요구 조건에서부터 데이터베이스 구조를 도출하는 과정
- 설계 단계 (요 개 논 물)
  - 요구 조건 분석
  - 개념적 설계 : ERD 구성
  - 논리적 설계 : 현실 세계의 요구사항과 목표 데이터 모델 기반 설계, 정규화와 트랜잭션 인터페이스 설계
  - 물리적 설계 : 구조 및 성능에 대한 설계, 반정규화 

### 데이터 모델링
- 데이터 모델 구조
  - 개체 
  - 개체 타입 : 속성들의 집합
  - 개체 인스턴스 : 한 행, 구체적인 객체
  - 개체 세트 : 개체 인스턴스 집합
  - 속성 : 개체의 고유한 특성
  - 관계 : 개체와 개체 간의 연관성
- 데이터모델 표시해야할 요소
  - 구조 : 데이터 구조 및 개체 간 관계
  - 연산 : 데이터 처리 방법
  - 제약조건 : 데이터의 논리적 제약 조건 
- E-R Model 
  - 개체 : 현실 세계의 독립적이고 구별 가능한 대상
  - 속성, 애트리뷰트 : 고유한 특성 (단일 값, 다중 값, 단순, 복합, 유도, 널, 키 속성)
  - 관계 : 두 개체 간 의미 있는 연결 → 마름모로 표현 
  - 기호 : 사각형(개체), 마름모(관계), 타원(속성), 밑줄타원(기본키 속성), 이중 타원(복합 속성)
- 데이터 모델의 품질 기준 (정완이가 준 강아지 중에 제일 활발해)
  - 정확성 : 요구사항 정확히 반영
  - 완전성 : 요구사항이 완전하게 반영
  - 준거성 : 준수 요건들이 정확하게 준수
  - 최신성 : 현재의 시스템 상태와 최근의 이슈사항 반영
  - 일관성 : 데이터 요소의 일관성 유지
  - 활용성 : 이해 관계자에게 의미 전달이 용이 

### 논리 데이터베이스 설계
- 논리적 데이터 모델링 : 개념적 설계 단계에서 도출된 개체, 속성, 관계를 구조적으로 표현하는 과정
- 정규화 : 데이터 중복을 최소화하기 위한 과정, 이상현상 최소화
  - 이상현상 : 데이터 중복으로 릴레이션 조작 시 발생하는 예기치 않은 문제 ( 삽 삭 갱 ) 
    - 삽입 이상 : 불필요한 데이터 함께 삽입
    - 삭제 이상 : 연쇄 삭제 현상으로 정보 손실
    - 갱신 이상 : 일부 튜플의 정보만 갱신된 정보 모순 
  - 함수적 종속 X → Y
    - 완전 함수적 종속 : 종속자가 기본키에만 종속
    - 부분 함수적 종속 : 기본키를 구성하는 속성 중 일부만 종속되는 경우
    - 이행적 함수 종속 : X → Y, Y → Z 일 때 X → Z 성립
  - 정규화 과정
    - 비정규 릴레이션 → (원자값) 1NF → (부분적 함수 종속 제거) 2NF → (이행적 함수 종속 제거) 3NF → (결정자 중 후보키 아닌 것 제거) BCNF → (다치 종속 제거) 4NF → (조인 종속성 이용) 5NF 
### 물리 데이터베이스 설계
- 데이터 타입과 그 크기 결정, 역정규화 진행, 인덱스 설계, 데이터베이스 생성 
- 반정규화 : 성능 향상이나 개발 및 운영의 편의성을 위해 의도적으로 중복을 허용하거나 데이터를 재구성하는 기법 
- 데이터베이스 이중화 : 장애에 대비해 동일한 데이터베이스 중복 관리 방식 for 고가용성
  - Eager : 트랜잭션 발생 시 즉시 반영
  - Lazy : 트랜잭션 완료 후 반영
- 데이터베이스 백업 : 데이터를 주기적으로 복사하여 보관
  - 전체 백업 : 모든 데이터 백업
  - 증분 백업 : 변경/추가된 데이터만 백업
  - 차등 백업 : 모든 변경/추가된 데이터를 백업
  - 합성 백업 : 전체 백업본과 여러 개의 증분 백업을 합해 새로운 전체 백업을 만듦
- 복구 시간 목표, 시점 목표!!
  - RTO (복구 시간 목표) : 서비스를 사용할 수 없는 상태로 허용되는 시간
  - RPO (복구 시점 목표) : 마지막 백업 이후 허용되는 최대 데이터 손실 시간 

### 데이터베이스 물리속성 설계
1. 파티셔닝 : 데이터베이스의 특정 부분을 여러 섹션으로 분할하는 방법
   - 샤딩 : 거대 DB나 시스템을 작은 조각으로 나누어 분산 저장 및 관리하는 기법 
   - 종류 : 수직 분할(열 기준), 수평 분할(행 기준)
   - 분할 기준
     - 범위 분할 
     - 목록 분할
     - 해시 분할 
     - 라운드 로빈 분할
     - 합성 분할 
2. 클러스터 설계 : 자주 사용되는 테이블의 데이터를 디스크 상 동일한 위치에 저장해 데이터 액세스 효율을 향상 
3. 인덱스 : 검색 속도 향상을 위한 저장 공간 활용 자료구조 (책의 색인 같은거)
   - 종류 : 클러스터 인덱스, 넌클러스터 인덱스 (따로 인덱스 페이지 만드는 것, 포인터 이용), 밀집 인덱스, 희소 인덱스 
4. 뷰 : 기본 테이블에서 유도된 이름이 있는 가상 테이블, 실제 저장하지 않은 논리적으로만 존재
5. 시스템 카탈로그 : DB의 모든 데이터 개체들에 대한 정보를 저장한 시스템 테이블, 데이터 사전(DD)라고도 한다
→ 검색속도 향상을 위해 파티셔닝, 클러스터링, 인덱스, 뷰 등을 모두 시도하다가 마지막에 반정규화 진행하는 거임!

### 관계 데이터베이스 모델
- 데이터의 논리적 구조를 테이블 형태로 표현, 튜플(행)과 속성(열)로 구성
- 속성, 튜플(행, 속성들의 모임), 도메인(속성 값의 범위), 차수(속성의 총 개수), 카디널리티(튜플의 총 개수)
- 관계데이터 언어
  - 관계대수 : 절차적 언어 
    - SELECT 시그마 (튜플 선택) [ 시그마 성적 > 90 ^ 학과 = 컴퓨터 (학생) ]
    - PROJECT 파이 (각 열을 가져오는 것) [ 파이 학번, 이름, 성적(시그마 성적 >= 90 (학생) ]
    - JOIN 보타이 [ (학생) 보타이 학생.학번 = 수강과목.학번 (수강과목) ]
    - DIVISION 나누기 (릴레이션 S의 모든 튜플과 관련있는 릴레이션 R의 튜플) [ R 나누기 S ] 
  - 관계해석 : 비절차적 언어 
### 키와 무결성 제약조건
1. 속성(컬럼) : 정보의 최소 단위
2. 키 종류 : 슈퍼키(유일성), 후보키(최소성), 기본키(선택된 주 키), 대체키(기본키를 제외한 후보키), 외래키(다른키와 릴레이션의 기본키를 참조하는 속성)
3. 데이터베이스 무결성 : 데이터의 정확성, 일관성, 유효성을 보장하는 DBMS의 중요한 기능
   - 개체 무결성 : NULL, 중복 불가
   - 참조 무결성 : 외래키는 NULL이거나 참조 릴레이션의 기본키와 일치해야 함(Restrict, CasCade)
   - 도메인 무결성 : 속성 값은 정의된 도메인에 속해야 한다
   - 고유 무결성 : 릴레이션의 특정 속성 값은 서로 달라야 한다
   - 키 무결성 : 각 릴레이션은 적어도 하나의 키를 가져야 한다
   - 릴레이션 무결성 : 삽,삭,갱 연산은 릴레이션의 무결성을 해치지 않도록 수행되어야 한다
### 물리데이터 모델 품질 검토
1. CRUD : 데이터 처리 기능
2. 옵티마이저(구문분석, 실행, 인출) : SQL을 가장 빠르고 효율적으로 수행할 최적의 처리경로를 생성해주는 DBMS 내부의 핵심엔진
   - 규칙 기반 옵티마이저 : 규칙을 가지고 실행 계획 생성
   - 비용 기반 옵티마이저 : 소요 시간이나 자원 사용량을 가지고 실행계획 생성 
3. SQL 성능 튜닝 : SQL문을 최적화하여 시스템의 처리량과 응답 속도를 개선하는 작업
### 분산 데이터베이스
- 여러 곳에 분산된 데이터베이스를 하나의 논리적인 시스템처럼 사용할 수 있는 데이터베이스
  - 구성요소 : 분산 처리기 , 분산 데이터베이스, 통신 네트워크 
  - CAP 이론 : 어떤 분산 환경에서도 일관성(C), 가용성(A), 분단 허용성(P) 세 가지 속성 중, 두 가지만 가질 수 있다는 것 
- 트랜잭션 : 하나의 논리적 기능을 수행하는 작업 단위
  - 성질 (A C I D)
    - 원자성(Atomicity) : 모두 반영되거나 전혀 반영되지 않거나
    - 일관성(Consistency) : 트랜잭션 완료 후에는 DB가 일관된 상태를 유지해야 
    - 독립성, 격리성(Isolation) : 동시에 실행되는 여러 트랜잭션들은 서로 간섭할 수 없다
    - 영속성(Durability) : Commit된 결과는 시스템에 고장이 발생해도 영구적으로 반영되어야 한다
  - 상태
    - 활동 : 트랜잭션 실행 중인 상태
    - 실패 : 트랜잭션 실행에 오류가 발생해 중단된 상태
    - 철회 : 비정상적으로 종료되어 RollBack연산 수행한 상태
    - 부분 완료 : Commit 연산이 실행되기 직전의 상태
    - 완료 : 트랜잭션이 성공적으로 종료되어 Commit까지 실행한 상태


## SQL 활용
### 기본 SQL 작성
- SQL : 구조적 데이터 질의 언어
  - DDL - 데이터 정의어 : CREATE, ALTER, DROP, RENAME, TRUNCATE
    1. CREATE(데이터베이스, 테이블, 인덱스, 뷰)
       ```sql
        CREATE DATABASE db;
       
        CREATE TABLE 회원( 
       USER_NO int not null auto_increment,
       name varchar(10) not null,
       age int(10) default '0',
       primary Key (user_NO)
       );
       
       CREATE INDEX search_name on 회원(name);
       CREATE VIEW v_user AS SELECT name, age FROM 회원;
       ```
    2. ALTER
       ```sql
       ALTER TABLE 회원 ADD ADDR VARCHAR(200) null;
       ALTER TABLE 회원 MODIFY AGE INT(11);
       ALTER TABLE 회원 DROP COLUMN AGE;
       
       ALTER INDEX 회원명 RENAME TO 성명;
       ```
    3. DROP : 객체 삭제
       ```sql
       DROP TABLE 회원;
       ```
    4. TRUNCATE : 구조는 남기고 데이터만 비운다
       ```sql
       TRUNCATE [TABLE] 회원;
       ```
    5. 제약 조건
       ```sql
       Primary Key (열);
       Foreign Key (user_id) references user(id) on delete cascade;
       user_id varchar(10) unique not null;
       ```
  - DML - 데이터 조작어 : SELECT, INSERT, DELETE, UPDATE
    1. INSERT
       ```sql
       INSERT INTO 회원 (name, age) values ('홍길동', 30);
       ```
    2. SELECT
       ```sql
       select name from 회원
       where distinct name likes = '홍%' and age between (20, 30);
       
       select 부서, count(*) from 사원정보 group by 부서 
       having count(*) >= 2
       order by 2;
       ```
    3. UPDATE : 기존 테이블의 데이터 갱신
       ```sql
       UPDATE 사원정보 SET 나이 = 나이 + 1;
       UPDATE 사원정보 SET 부서 = '인사팀' WHERE 부서='인사지원팀';
       ```
    4. DELETE : 기존 테이블의 데이터 삭제
       ```sql
       DELETE FROM 사원정보 where 부서='디자인' and 이름='홍길동';
       ```
  - DCL - 데이터 제어어 : GRANT, REVOKE, COMMIT, ROLLBACK, SAVEPOINT
    1. GRANT : GRANT [권한] ON [객체명] TO [사용자 계정] [WITH GRANT OPTION];
       ```sql
       GRANT SELECT ON 사원정보 TO SUMIN WITH GRANT OPTION;
       ```
    2. REVOKE : REVOKE [권한] ON [객체명] FROM [사용자 계정] [CASCADE];
       ```sql
       REVOKE SELECT ON 사원정보 FROM Hungjik;
       ```
  - TCL : COMMIT, ROLLBACK
### SELECT 쿼리 활용 
1. 집합 연산자
   - UNION : 합집합, 중복 제거
   - UNION ALL : 합집합, 중복 포함
   - INTERSECT : 교집합, 중복 제거
   - MINUS : 차집합
2. JOIN 
   - INNER JOIN : 공통 데이터만 추출
   - NATURAL JOIN : 동일한 이름과 타입을 가진 컬럼을 기준으로 자동 조인 
   - FULL OUTER JOIN : 좌측 우측 데이터 모두 포함, 중복 제거
   - LEFT OUTER JOIN | RIGHT OUTER JOIN
   - CROSS JOIN : 두 테이블 모든 조합을 반환 
3. 서브쿼리 
   - 스칼라 서브쿼리 : select 문 안에 또 다른 select 문이 포함
   - 인라인뷰 서브쿼리 : FROM 절에 존재 
   - 중첩 서브쿼리 : WHERE 절에 존재, IN, EXISTS, ANY, ALL
### 그룹함수와 윈도우 함수
- GROUP BY, ROLL UP, CUBE
### 절차형 SQL
- 저장 프로시저 : 일련의 쿼리를 마치 하나의 함수처럼 실행하기 위한 쿼리의 집합
- 트리거 : 테이블에 대한 이벤트에 반응해 자동으로 실행되는 작업 
- 사용자 정의 함수 : 프로시저와 사용자 정의 함수 모두 호출하게 되면 미리 정의해 놓은 기능을 수행하는 모듈 


## 병행제어와 데이터 전환
### 병행제어와 회복
1. 병행제어 : 여러 트랜젝션이 동시에 실행되면서도 데이터베이스의 일관성을 유지하는 기법
    - 문제점
      1. 갱신 분실 : 일부 갱신 결과가 손실되는 현상
      2. 비완료 의존성 : 실패한 트랜잭션의 결과를 다른 트랜잭션이 참조하는 현상
      3. 모순성 : 병생 수행 중 원치 않는 자료를 사용함으로써 발생하는 문제
      4. 연쇄 복귀 : 하나의 트랜잭션이 실패해 롤백되면, 다른 트랜잭션도 함께 롤백되는 현상 
    - 병행제어 기법
      1. 로킹 : 트랜잭션이 데이터에 접근하려면 로킹을 수행해야 한다. 로킹된 데이터는 다른 트랜잭션이 접근할 수 없다
      2. 2단계 로킹 규약
      3. 타임스탬프 : 데이터에 접근하는 시간을 미리 정해 순서대로 접근
      4. 낙관적 병행제어 : 트랜잭션 수행 동안 검사를 하지 않고, 종료 시 일괄적으로 검사
      5. 다중 버전 병행제어
2. 회복 : 장애로 인해 손상된 데이터베이스를 이전의 정상 상태로 복구하는 작업
   - 유형 : 트랜잭션 장애, 시스템 장애, 미디어 장애
   - UNDO : 트랜잭션 로그를 이용해 오류와 관련된 모든 변경을 취소하여 복구
     REDO : 트랜잭션 로그를 이용해 오류 발생 트랜잭션을 재실행하여 복구
   - 회복 기법
     1. 로그 기반
        1. 지연 갱신 → REDO
        2. 즉시 갱신 → UNDO, REDO
     2. 검사점 회복 기법 → 복사본 만들기
     3. 그림자 페이징 
     4. 미디어 회복 
     5. ARIES 회복
### 데이터 전환
- ETL : 추출, 변환, 적재 일련의 과정 
- 데이터 정제 
  1. 데이터 품질 관리 대상
  2. 데이터 값
  3. 데이터 구조
  4. 데이터 관리 프로세스 